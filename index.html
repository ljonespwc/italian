<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tourist Survival Italian</title>
  <meta name="description" content="A tiny offline phrasebook + quiz for Italian travel. Audio via your browser's Italian TTS voice.">
  <style>
    :root{
      --bg:#0f172a;      /* slate-900 */
      --panel:#111827;   /* gray-900 */
      --muted:#1f2937;   /* gray-800 */
      --text:#e5e7eb;    /* gray-200 */
      --accent:#22c55e;  /* green-500 */
      --accent2:#60a5fa; /* blue-400 */
      --danger:#f87171;  /* red-400 */
      --warn:#fbbf24;    /* amber-400 */
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,#0b1024 0%,#0f172a 100%);
      color:var(--text); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display:flex; flex-direction:column; align-items:center;
    }
    .app{width:min(1000px,100%); padding:16px 12px 32px}
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      background:rgba(17,24,39,.7); backdrop-filter: blur(8px); padding:12px 14px; border-radius:var(--radius);
      box-shadow:var(--shadow); position:sticky; top:0; z-index:10;
    }
    .title{display:flex; flex-direction:column}
    .title h1{margin:0; font-size:20px; letter-spacing:.2px}
    .title small{opacity:.75}
    .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
    .btn{
      border:none; outline:none; padding:10px 12px; border-radius:12px; background:var(--muted); color:var(--text);
      cursor:pointer; box-shadow:var(--shadow); transition:transform .05s ease, background .2s ease, opacity .2s;
      font-weight:600; letter-spacing:.2px; display:inline-flex; align-items:center; gap:8px;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(135deg,var(--accent2),var(--accent)); color:#0b1024}
    .btn.warn{background:var(--warn); color:#0b1024}
    .btn.ghost{background:transparent; box-shadow:none; border:1px solid #374151}
    .segmented{
      display:inline-flex; background:var(--muted); padding:4px; border-radius:12px; gap:4px; box-shadow:var(--shadow);
    }
    .segmented button{background:transparent; padding:8px 10px; border-radius:8px; border:1px solid transparent}
    .segmented button.active{background:#0b1024; border-color:#334155}
    .switch{display:flex; align-items:center; gap:8px}
    .switch input{accent-color:var(--accent)}
    .panel{
      margin-top:16px; background:rgba(17,24,39,.75); border:1px solid #1f2a44; border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow)
    }
    .row{display:flex; gap:10px; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #1f2a44}
    .row:last-child{border-bottom:none}
    .row .text{display:flex; flex-direction:column; gap:4px}
    .row .small{opacity:.75; font-size:13px}
    .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#0b1024; border:1px solid #253149; font-size:13px; opacity:.9}
    .list-controls{display:flex; flex-wrap:wrap; gap:10px; padding:12px; border-bottom:1px solid #1f2a44; align-items:center; justify-content:space-between}
    input[type="search"], select{
      background:#0a1022; border:1px solid #2a3759; color:var(--text); padding:10px 12px; border-radius:12px; outline:none; min-width:140px
    }
    input[type="number"]{width:72px; text-align:center; padding:8px 6px; border-radius:8px; border:1px solid #2a3759; background:#0a1022; color:var(--text)}
    .grid{display:grid; grid-template-columns: 1fr; }
    @media(min-width:720px){ .grid{grid-template-columns: 1fr 1fr} }
    .fav{cursor:pointer; font-size:20px; opacity:.8}
    .fav.active{color:var(--warn); opacity:1}
    .muted{opacity:.65}
    .empty{padding:20px; text-align:center; opacity:.8}
    .footer{margin-top:24px; opacity:.7; font-size:13px; text-align:center}
    .kbd{border:1px solid #475569; border-bottom-width:3px; padding:2px 6px; border-radius:6px; background:#0a1022; font-family:ui-monospace, SFMono-Regular, Menlo, monospace}
    .pill{padding:4px 10px; border-radius:999px; background:#0a1022; border:1px solid #334155; font-size:12px; opacity:.9}
    .quiz-wrap{padding:16px}
    .question{font-size:18px; margin:6px 0 14px}
    .answers{display:grid; gap:10px}
    .answers button{padding:12px; border-radius:12px; border:1px solid #2a3759; background:#0a1022; color:var(--text); text-align:left; cursor:pointer}
    .answers button.correct{border-color:#16a34a; background:rgba(22,163,74,.15)}
    .answers button.wrong{border-color:#f87171; background:rgba(248,113,113,.15)}
    .progress{height:8px; background:#1f2a44; border-radius:999px; overflow:hidden}
    .progress > div{height:100%; background:linear-gradient(135deg,var(--accent2),var(--accent)); width:0%}
    .settings{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .badge{padding:4px 8px; border-radius:6px; background:#0a1022; border:1px solid #334155; font-size:12px}
    .hint{font-size:13px; opacity:.75; margin-top:4px}
    a, a:visited{color:#93c5fd}
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div class="title">
        <h1>Tourist Survival Italian</h1>
        <small>Phrasebook + Audio + Quiz (offline)</small>
      </div>
      <div class="controls">
        <div class="segmented" role="tablist" aria-label="Mode">
          <button id="mode-phrasebook" class="active" aria-pressed="true">Phrasebook</button>
          <button id="mode-quiz" aria-pressed="false">Quiz</button>
        </div>
        <div class="segmented" role="group" aria-label="Language direction">
          <button id="dir-en-it" class="active" aria-pressed="true">EN â†’ IT</button>
          <button id="dir-it-en" aria-pressed="false">IT â†’ EN</button>
        </div>
        <button id="installBtn" class="btn ghost" title="Add to Home Screen">âž• Install</button>
      </div>
    </header>

    <!-- Phrasebook Panel -->
    <section id="phrasebook" class="panel" aria-labelledby="mode-phrasebook">
      <div class="list-controls">
        <div class="settings">
          <label class="pill">Category:
            <select id="catSelect" aria-label="Category filter"></select>
          </label>
          <label class="pill">Voice:
            <select id="voiceSelect" aria-label="Voice selection"></select>
          </label>
          <label class="switch">
            <input type="checkbox" id="slowToggle"> <span class="small">Slow audio</span>
          </label>
          <span id="countBadge" class="badge"></span>
        </div>
        <input id="searchInput" type="search" placeholder="Search phrasesâ€¦" aria-label="Search phrases">
      </div>
      <div id="phraseList" class="grid" role="list"></div>
      <div id="emptyState" class="empty" hidden>No matches. Try another category or search term.</div>
    </section>

    <!-- Quiz Panel -->
    <section id="quiz" class="panel" aria-labelledby="mode-quiz" hidden>
      <div class="row">
        <div class="text">
          <strong>Quiz settings</strong>
          <span class="small">Choose what to practice and how many questions.</span>
        </div>
        <div class="settings">
          <label class="pill">Category:
            <select id="quizCat"></select>
          </label>
          <label class="pill">Questions:
            <input id="quizCount" type="number" min="5" max="50" value="10">
          </label>
          <label class="pill">Direction:
            <select id="quizDir">
              <option value="en-it">EN â†’ IT</option>
              <option value="it-en">IT â†’ EN</option>
            </select>
          </label>
          <button id="startQuiz" class="btn primary">Start Quiz</button>
        </div>
      </div>
      <div id="quizArea" class="quiz-wrap" hidden>
        <div class="progress" aria-label="Progress"><div id="progBar"></div></div>
        <div class="row">
          <div class="text">
            <div id="qBadge" class="chip">Question <span id="qIndex">1</span>/<span id="qTotal">10</span></div>
            <div id="question" class="question"></div>
            <div id="hint" class="hint"></div>
          </div>
          <div class="settings">
            <button id="speakQ" class="btn">ðŸ”Š Speak</button>
            <button id="skipQ" class="btn ghost">Skip</button>
          </div>
        </div>
        <div id="answers" class="answers" role="listbox" aria-label="Answers"></div>
      </div>
      <div id="quizSummary" class="quiz-wrap" hidden></div>
    </section>

    <div class="footer">
      Pro tip: tap ðŸ”Š to hear Italian with an <span class="kbd">it-IT</span> voice. Add to Home Screen with <span class="kbd">Share â†’ Add</span> (iOS) or <span class="kbd">â‹® â†’ Install app</span> (Android).
    </div>
  </div>

<script>
  // ------------------ DATA ------------------
  const PHRASES = [
    // Essentials
    {cat:"Essentials", en:"Hello / Hi", it:"Ciao"},
    {cat:"Essentials", en:"Good morning", it:"Buongiorno"},
    {cat:"Essentials", en:"Good evening", it:"Buonasera"},
    {cat:"Essentials", en:"Goodbye", it:"Arrivederci"},
    {cat:"Essentials", en:"Please", it:"Per favore"},
    {cat:"Essentials", en:"Thank you", it:"Grazie"},
    {cat:"Essentials", en:"Excuse me / Sorry", it:"Mi scusi"},
    {cat:"Essentials", en:"You're welcome", it:"Prego"},
    {cat:"Essentials", en:"My name is Lance", it:"Mi chiamo Lance"},
    {cat:"Essentials", en:"Nice to meet you", it:"Piacere"},

    // Food & Drink
    {cat:"Food & Drink", en:"I would like a coffee", it:"Vorrei un caffÃ¨"},
    {cat:"Food & Drink", en:"I would like a glass of wine", it:"Vorrei un bicchiere di vino"},
    {cat:"Food & Drink", en:"I would like still water", it:"Vorrei acqua naturale"},
    {cat:"Food & Drink", en:"I would like sparkling water", it:"Vorrei acqua frizzante"},
    {cat:"Food & Drink", en:"Can I haveâ€¦?", it:"Posso avereâ€¦?"},
    {cat:"Food & Drink", en:"The bill, please", it:"Il conto, per favore"},
    {cat:"Food & Drink", en:"A table for two, please", it:"Un tavolo per due, per favore"},
    {cat:"Food & Drink", en:"What do you recommend?", it:"Che cosa consiglia?"},
    {cat:"Food & Drink", en:"I am allergic toâ€¦", it:"Sono allergico/a aâ€¦"},

    // Getting Around
    {cat:"Getting Around", en:"Where is the station?", it:"Dovâ€™Ã¨ la stazione?"},
    {cat:"Getting Around", en:"Where is the bathroom?", it:"Dovâ€™Ã¨ il bagno?"},
    {cat:"Getting Around", en:"How much is the ticket?", it:"Quanto costa il biglietto?"},
    {cat:"Getting Around", en:"One ticket, please", it:"Un biglietto, per favore"},
    {cat:"Getting Around", en:"Left", it:"Sinistra"},
    {cat:"Getting Around", en:"Right", it:"Destra"},
    {cat:"Getting Around", en:"Straight ahead", it:"Dritto"},
    {cat:"Getting Around", en:"Near / Far", it:"Vicino / Lontano"},
    {cat:"Getting Around", en:"I need a taxi", it:"Mi serve un taxi"},

    // Shopping & Money
    {cat:"Shopping & Money", en:"How much does it cost?", it:"Quanto costa?"},
    {cat:"Shopping & Money", en:"Iâ€™ll take it", it:"Lo prendo"},
    {cat:"Shopping & Money", en:"Can I pay by card?", it:"Posso pagare con carta?"},
    {cat:"Shopping & Money", en:"Do you have this in another size?", it:"Ce lâ€™ha in unâ€™altra misura?"},
    {cat:"Shopping & Money", en:"Cheaper / More expensive", it:"PiÃ¹ economico / PiÃ¹ caro"},
    {cat:"Shopping & Money", en:"Receipt, please", it:"Lo scontrino, per favore"},

    // Emergencies
    {cat:"Emergencies", en:"Help!", it:"Aiuto!"},
    {cat:"Emergencies", en:"I am lost", it:"Mi sono perso/a"},
    {cat:"Emergencies", en:"I donâ€™t understand", it:"Non capisco"},
    {cat:"Emergencies", en:"Do you speak English?", it:"Parla inglese?"},
    {cat:"Emergencies", en:"I need a doctor", it:"Ho bisogno di un dottore"},
    {cat:"Emergencies", en:"Call the police", it:"Chiami la polizia"},

    // Small Talk
    {cat:"Small Talk", en:"Where are you from?", it:"Di dove sei?"},
    {cat:"Small Talk", en:"I am Canadian", it:"Sono canadese"},
    {cat:"Small Talk", en:"Do you like it?", it:"Ti piace?"},
    {cat:"Small Talk", en:"Itâ€™s very beautiful here", it:"Ãˆ molto bello qui"},
    {cat:"Small Talk", en:"Iâ€™m here on vacation", it:"Sono qui in vacanza"},
    {cat:"Small Talk", en:"We love Italian food", it:"Amiamo il cibo italiano"},
  ];

  const CATS = ["All","Essentials","Food & Drink","Getting Around","Shopping & Money","Emergencies","Small Talk","Favorites"];

  // ------------------ STATE ------------------
  const $ = (sel,root=document)=> root.querySelector(sel);
  const $$ = (sel,root=document)=> [...root.querySelectorAll(sel)];
  let MODE = "phrasebook";   // "phrasebook" | "quiz"
  let DIR = "en-it";         // "en-it" | "it-en"
  let FAVORITES = new Set(JSON.parse(localStorage.getItem("favorites")||"[]"));
  let SETTINGS = JSON.parse(localStorage.getItem("settings")||"{}");
  let VOICES = [];
  let ITALIAN_VOICE_INDEX = null;

  // ------------------ INIT ------------------
  function init(){
    // Mode toggles
    bindModes();

    // Direction toggles
    bindDirection();

    // Populate selects
    populateCategory($("#catSelect"));
    populateCategory($("#quizCat"));
    $("#quizCat").value = "All";

    // Voice select
    refreshVoices();
    if ('speechSynthesis' in window) {
      window.speechSynthesis.onvoiceschanged = refreshVoices;
    }

    // Phrasebook handlers
    $("#searchInput").addEventListener("input", renderList);
    $("#catSelect").addEventListener("change", renderList);
    $("#slowToggle").checked = SETTINGS.slow || false;
    $("#slowToggle").addEventListener("change", e => {
      SETTINGS.slow = e.target.checked;
      localStorage.setItem("settings", JSON.stringify(SETTINGS));
    });
    $("#voiceSelect").addEventListener("change", e => {
      SETTINGS.voiceURI = e.target.value;
      localStorage.setItem("settings", JSON.stringify(SETTINGS));
    });

    renderList();
    bindInstall();
    bindQuiz();
  }

  // ------------------ MODES ------------------
  function bindModes(){
    const pb = $("#mode-phrasebook"), qz = $("#mode-quiz");
    pb.addEventListener("click", ()=>{
      MODE="phrasebook";
      pb.classList.add("active"); pb.setAttribute("aria-pressed","true");
      qz.classList.remove("active"); qz.setAttribute("aria-pressed","false");
      $("#phrasebook").hidden=false; $("#quiz").hidden=true;
    });
    qz.addEventListener("click", ()=>{
      MODE="quiz";
      qz.classList.add("active"); qz.setAttribute("aria-pressed","true");
      pb.classList.remove("active"); pb.setAttribute("aria-pressed","false");
      $("#phrasebook").hidden=true; $("#quiz").hidden=false;
    });
  }

  // ------------------ DIRECTION ------------------
  function bindDirection(){
    const enit = $("#dir-en-it"), iten = $("#dir-it-en");
    enit.addEventListener("click", ()=>{
      DIR="en-it"; enit.classList.add("active"); enit.setAttribute("aria-pressed","true");
      iten.classList.remove("active"); iten.setAttribute("aria-pressed","false");
      renderList();
    });
    iten.addEventListener("click", ()=>{
      DIR="it-en"; iten.classList.add("active"); iten.setAttribute("aria-pressed","true");
      enit.classList.remove("active"); enit.setAttribute("aria-pressed","false");
      renderList();
    });
  }

  // ------------------ VOICES ------------------
  function refreshVoices(){
    const list = window.speechSynthesis?.getVoices?.() || [];
    VOICES = list.filter(v => v.lang?.toLowerCase().startsWith("it")); // prefer Italian
    // fallback: allow all voices if no Italian found
    const allow = VOICES.length ? VOICES : list;
    const sel = $("#voiceSelect");
    sel.innerHTML = "";
    allow.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v.voiceURI;
      opt.textContent = `${v.name} (${v.lang})`;
      sel.appendChild(opt);
    });
    // prefer saved voice or first italian
    let chosen = allow[0]?.voiceURI || "";
    if (SETTINGS.voiceURI && allow.some(v=>v.voiceURI===SETTINGS.voiceURI)) chosen = SETTINGS.voiceURI;
    sel.value = chosen;
    SETTINGS.voiceURI = chosen;
    localStorage.setItem("settings", JSON.stringify(SETTINGS));
  }

  function speak(text, langHint="it-IT"){
    if (!("speechSynthesis" in window)) return alert("Speech not supported in this browser.");
    const u = new SpeechSynthesisUtterance(text);
    const voices = window.speechSynthesis.getVoices();
    if (SETTINGS.voiceURI){
      const v = voices.find(v=>v.voiceURI===SETTINGS.voiceURI);
      if (v) u.voice = v;
    } else {
      const it = voices.find(v => v.lang?.toLowerCase().startsWith("it")) || voices[0];
      if (it) u.voice = it;
    }
    u.lang = u.voice?.lang || langHint;
    u.rate = $("#slowToggle").checked ? 0.85 : 1.0;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }

  // ------------------ PHRASEBOOK ------------------
  function populateCategory(sel){
    sel.innerHTML = "";
    CATS.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      sel.appendChild(opt);
    });
    sel.value = "All";
  }

  function renderList(){
    const q = $("#searchInput").value.trim().toLowerCase();
    const cat = $("#catSelect").value;
    const list = $("#phraseList");
    list.innerHTML = "";

    let data = PHRASES.slice();
    if (cat !== "All" && cat !== "Favorites"){
      data = data.filter(p=>p.cat===cat);
    }
    if (cat === "Favorites"){
      data = data.filter(p => FAVORITES.has(keyFor(p)));
    }
    if (q){
      data = data.filter(p => (p.en+" "+p.it).toLowerCase().includes(q));
    }

    $("#countBadge").textContent = `${data.length} phrase${data.length===1?"":"s"}`;

    if (!data.length){
      $("#emptyState").hidden = false;
      return;
    } else {
      $("#emptyState").hidden = true;
    }

    data.forEach(p => {
      const row = document.createElement("div");
      row.className = "row";
      row.role = "listitem";

      const k = keyFor(p);
      const fav = document.createElement("div");
      fav.className = "fav" + (FAVORITES.has(k) ? " active" : "");
      fav.title = FAVORITES.has(k) ? "Remove from favorites" : "Add to favorites";
      fav.textContent = FAVORITES.has(k) ? "â˜…" : "â˜†";
      fav.addEventListener("click", ()=>{
        if (FAVORITES.has(k)){ FAVORITES.delete(k); } else { FAVORITES.add(k); }
        localStorage.setItem("favorites", JSON.stringify([...FAVORITES]));
        renderList();
      });

      const text = document.createElement("div");
      text.className = "text";
      const top = document.createElement("div");
      const bottom = document.createElement("div");
      bottom.className = "small muted";

      if (DIR==="en-it"){
        top.textContent = p.en;
        bottom.textContent = p.it;
      } else {
        top.textContent = p.it;
        bottom.textContent = p.en;
      }

      text.appendChild(top);
      text.appendChild(bottom);

      const right = document.createElement("div");
      right.style.display="flex"; right.style.gap="8px"; right.style.alignItems="center";

      const catChip = document.createElement("span");
      catChip.className = "chip"; catChip.textContent = p.cat;

      const speakBtn = document.createElement("button");
      speakBtn.className = "btn";
      speakBtn.textContent = "ðŸ”Š";
      speakBtn.title = "Speak Italian";
      speakBtn.addEventListener("click", ()=> speak(p.it));

      right.appendChild(catChip);
      right.appendChild(speakBtn);

      row.appendChild(text);
      row.appendChild(right);
      row.appendChild(fav);
      list.appendChild(row);
    });
  }

  function keyFor(p){ return `${p.cat}|${p.en}|${p.it}`; }

  // ------------------ QUIZ ------------------
  let QUIZ = null;
  function bindQuiz(){
    $("#startQuiz").addEventListener("click", startQuiz);
    $("#speakQ").addEventListener("click", ()=>{
      if (!QUIZ) return;
      const {dir, items, index} = QUIZ;
      const p = items[index];
      const text = dir==="en-it" ? p.it : p.en;
      // Speak in Italian if playing Italian; otherwise English
      speak(text, dir==="en-it" ? "it-IT" : "en-US");
    });
    $("#skipQ").addEventListener("click", ()=>{
      if (!QUIZ) return;
      advance(false, true);
    });
  }

  function startQuiz(){
    const cat = $("#quizCat").value;
    const n = Math.max(5, Math.min(50, parseInt($("#quizCount").value||"10",10)));
    const dir = $("#quizDir").value;

    let pool = PHRASES.slice();
    if (cat !== "All"){
      pool = pool.filter(p=>p.cat===cat || (cat==="Favorites" && FAVORITES.has(keyFor(p))));
    } else if (cat === "Favorites"){
      pool = pool.filter(p=>FAVORITES.has(keyFor(p)));
    }
    if (pool.length < 4){
      alert("Not enough phrases in this category for a quiz. Try All or add more Favorites.");
      return;
    }

    shuffle(pool);
    const items = pool.slice(0, Math.min(n, pool.length));
    QUIZ = {dir, items, index:0, correct:0, answered:0, wrongList:[]};
    $("#qTotal").textContent = items.length;
    $("#quizArea").hidden = false;
    $("#quizSummary").hidden = true;
    showQuestion();
  }

  function showQuestion(){
    const q = QUIZ;
    const p = q.items[q.index];
    $("#qIndex").textContent = q.index+1;
    $("#progBar").style.width = `${(q.index/q.items.length)*100}%`;

    const prompt = q.dir==="en-it" ? p.en : p.it;
    const answer = q.dir==="en-it" ? p.it : p.en;
    const hint = q.dir==="en-it" ? p.it : p.en; // show opposite as hint after selection

    $("#question").textContent = prompt;
    $("#hint").textContent = "";

    // Build 4 options (1 correct + 3 distractors)
    const opts = [answer];
    const pool = PHRASES.filter(x => keyFor(x) !== keyFor(p));
    shuffle(pool);
    for (let i=0;i<3;i++){
      opts.push(q.dir==="en-it" ? pool[i].it : pool[i].en);
    }
    shuffle(opts);

    const answers = $("#answers");
    answers.innerHTML = "";
    opts.forEach(txt => {
      const b = document.createElement("button");
      b.textContent = txt;
      b.addEventListener("click", ()=>{
        if (b.dataset.done) return;
        b.dataset.done = "1";
        const isCorrect = txt === answer;
        b.classList.add(isCorrect ? "correct" : "wrong");
        $("#hint").textContent = `Answer: ${answer}`;
        q.answered++;
        if (isCorrect){ q.correct++; setTimeout(()=>advance(true,false), 450); }
        else {
          // Re-queue wrong items later ("spaced re-ask")
          q.wrongList.push({p, dir:q.dir});
          setTimeout(()=>advance(false,false), 600);
        }
      });
      answers.appendChild(b);
    });
  }

  function advance(correct, skipped){
    const q = QUIZ;
    q.index++;
    if (q.index >= q.items.length){
      // If there were wrong answers, append them at end once more
      if (q.wrongList.length){
        const extra = q.wrongList.map(w=>w.p);
        q.items = q.items.concat(extra);
        q.wrongList = [];
      } else {
        return finishQuiz();
      }
    }
    if (q.index >= q.items.length) return finishQuiz();
    showQuestion();
  }

  function finishQuiz(){
    const q = QUIZ;
    $("#progBar").style.width = "100%";
    $("#quizArea").hidden = true;
    const pct = Math.round((q.correct / q.answered) * 100) || 0;
    const missCount = q.answered - q.correct;
    const review = document.createElement("div");
    review.innerHTML = `
      <div class="row">
        <div class="text">
          <strong>Results</strong>
          <div class="small">Score: <span class="badge">${pct}%</span> &nbsp; Correct: ${q.correct} / ${q.answered}</div>
        </div>
        <button id="retryQuiz" class="btn primary">Retry</button>
      </div>
      ${missCount ? `<div class="row"><div class="text"><strong>Review missed</strong><div class="small">Tap ðŸ”Š to hear them again.</div></div></div>` : ""}
      <div id="reviewList" class="grid"></div>
    `;
    const wrap = $("#quizSummary");
    wrap.innerHTML = "";
    wrap.appendChild(review);
    wrap.hidden = false;

    $("#retryQuiz").addEventListener("click", startQuiz);

    const list = $("#reviewList");
    if (missCount){
      // we didn't store which ones specifically were missed, but we can show the last segment (since wrongList is emptied)
      // Alternative: compute from answered wrong by checking re-added items. Here keep it simple: take the last slice that was added
      // For more precise tracking, we could store an array of misses; implement now:
    }

    // Build a precise review from items that were incorrect at least once
    // Modify: store misses in SETTINGS.lastMisses
    const misses = SETTINGS.lastMisses || [];
    list.innerHTML = "";
    if (!misses.length){
      const d = document.createElement("div");
      d.className="empty"; d.textContent="Nothing to review â€” nice work!";
      list.appendChild(d);
    } else {
      misses.forEach(m => {
        const row = document.createElement("div"); row.className="row";
        const text = document.createElement("div"); text.className="text";
        const top = document.createElement("div"); const bottom=document.createElement("div"); bottom.className="small muted";
        if (q.dir==="en-it"){ top.textContent = m.en; bottom.textContent = m.it; }
        else { top.textContent = m.it; bottom.textContent = m.en; }
        text.appendChild(top); text.appendChild(bottom);
        const right = document.createElement("div"); right.style.display="flex"; right.style.gap="8px"; right.style.alignItems="center";
        const speakBtn = document.createElement("button"); speakBtn.className="btn"; speakBtn.textContent="ðŸ”Š";
        speakBtn.addEventListener("click", ()=> speak(m.it));
        right.appendChild(speakBtn);
        row.appendChild(text); row.appendChild(right);
        list.appendChild(row);
      });
    }
  }

  // patch: actually capture misses during answer selection
  (function patchMissTracking(){
    const origShow = showQuestion;
    showQuestion = function(){
      // wrap answers to track misses
      origShow();
      // Replace click handlers to track misses precisely â€” we already add to wrongList, also store miss in SETTINGS.lastMisses
      const q = QUIZ;
      const p = q.items[q.index];
      const answer = q.dir==="en-it" ? p.it : p.en;
      $$("#answers button").forEach(b => {
        const prev = b.onclick; // none used
        b.addEventListener("click", ()=>{
          if (b.dataset.missTracked) return;
          b.dataset.missTracked = "1";
          const chosen = b.textContent;
          if (chosen !== answer){
            // save a copy (unique by key)
            const key = keyFor(p);
            const misses = SETTINGS.lastMisses || [];
            if (!misses.some(x => keyFor(x)===key)){
              misses.push(p);
              SETTINGS.lastMisses = misses;
              localStorage.setItem("settings", JSON.stringify(SETTINGS));
            }
          }
        }, {once:true});
      });
    }
  })();

  // ------------------ UTILS ------------------
  function shuffle(arr){
    for (let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
  }

  // ------------------ INSTALL (PWA-lite prompt) ------------------
  let deferredPrompt = null;
  function bindInstall(){
    const btn = $("#installBtn");
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      btn.disabled = false;
    });
    btn.addEventListener("click", async () => {
      if (deferredPrompt){
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
      } else {
        alert("Tip: On iPhone, use Share â†’ Add to Home Screen. On Android, use â‹® â†’ Install app.");
      }
    });
  }

  // ------------------ START ------------------
  init();
</script>
</body>
</html>
